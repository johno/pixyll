---
layout: post
title: Query Log Analytics from the Command Line
date: 2019-07-19
summary: |
 A little Python script to help query Azure Log Analytics from the
 command line.
tags: azure python log-analytics cli
---
I've been doing some work with Azure Log Analytics lately and found the
__az__ tool lacking when it comes to querying Log Analytics.  So like anyone
who gets an itch and needs to scratch it, I decided to put something together
myself to help make it a bit easier for me.  So using Python and some awesome
modules I put together a little utility that could query Log Analytics and
provide it back in a few different formats.

## Problem
Query Log Analytics using the command line.  The query tool should allow input from
stdin so that KQL can be piped in to the command like a normal Unix utility.
Additionally, the format of the output should be configurable so you can get
return results in json, txt or csv

## Solution 
[az-query-log-analytics](https://raw.githubusercontent.com/msft-csu/azure-scripts/master/log-analytics/az-query-log-analtyics.py)
takes a Kusto query (KQL) and passes it to the Log
Analytics REST API. It is NOT designed for large sets of data as it doesn't
attempt to break the return values up in any way. What it does do though is make the return
values useful. The REST API for Log Analytics provides a network friendly JSON
document format that minimizes bandwidth by listing the column names seperately
from the row data. This produces a more compact JSON document by reducing
redundancy in the JSON at the cost of usefulness. This script will refactor the
results into more useful formats like csv, table and verbose JSON. You need to
either pass a KQL file or pass it on stdin like below. It also requires an Azure
auth file as well as the workspace id for Log Analytics.

Options include:
-t, --timespan
-a, --azure-auth
-o, --output
-w, --workspace_id

The following environment variables can be used rather than passing on the command line...

* AZURE_AUTH_LOCATION
* LOG_ANALYTICS_WORKSPACE_ID

Let's look at some examples of what it can do

```terminal
>> python az-query-log-analtyics.py -t PT12H \
    -w xxxxxxxxxxxxxxxx \
    -a ~/.azureauth \
    -o json <<EOF |  
Heartbeat  
| project Computer, OSType, OSMajorVersion  
| limit 2  
EOF  
jq 

[  
  {  
    "Computer": "lin-7599",  
    "OSType": "Linux",  
    "OSMajorVersion": "18"  
  },  
  {  
    "Computer": "lin-7599",  
    "OSType": "Linux",  
    "OSMajorVersion": "18"  
  }  
]
```

In addition to normal JSON you can also export csv and table formats...

```terminal
>> python az-query-log-analtyics.py -t PT12H -o csv <<EOF                                              
Heartbeat
| project Computer, OSType, OSMajorVersion
| limit 2
EOF

Computer,OSType,OSMajorVersion
lin-7599,Linux,18
lin-7599,Linux,18
```
And if you want a standard table format

```terminal
â¯ python az-query-log-analtyics.py -t PT12H -o table <<EOF
Heartbeat                                                                                                           
| project Computer, OSType, OSMajorVersion                                                                          
| limit 2                                                                                                            
EOF                                                                                                                  

====================================================================
KQL:
Heartbeat
| project Computer, OSType, OSMajorVersion
| limit 2
====================================================================
 Computer OSType OSMajorVersion
 lin-7599  Linux             18
 lin-7599  Linux             18
```

So hopefully this helps others out there and if you want to contribute back just
open a pull request.


